name: AI Workflow

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  ai-task:
    if: contains(github.event.issue.title, '[AI]')
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Parse Issue
      id: parse
      run: |
        echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
        echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
        
    - name: Determine AI Tasks
      run: |
        # Graph RAG ê´€ë ¨
        if [[ "${{ github.event.issue.title }}" == *"Graph RAG"* ]]; then
          echo "TASK_TYPE=graph_rag" >> $GITHUB_ENV
          echo "ASSIGNED_AI=gemini,codex,claude" >> $GITHUB_ENV
        # Frontend ê´€ë ¨
        elif [[ "${{ github.event.issue.title }}" == *"frontend"* ]] || [[ "${{ github.event.issue.title }}" == *"UI"* ]]; then
          echo "TASK_TYPE=frontend" >> $GITHUB_ENV
          echo "ASSIGNED_AI=cursor" >> $GITHUB_ENV
        # Data ë¶„ì„
        elif [[ "${{ github.event.issue.title }}" == *"data"* ]] || [[ "${{ github.event.issue.title }}" == *"ë¶„ì„"* ]]; then
          echo "TASK_TYPE=data" >> $GITHUB_ENV
          echo "ASSIGNED_AI=chatgpt" >> $GITHUB_ENV
        else
          echo "TASK_TYPE=general" >> $GITHUB_ENV
          echo "ASSIGNED_AI=gemini,codex,claude" >> $GITHUB_ENV
        fi
        
    - name: Post Assignment Comment
      uses: actions/github-script@v6
      with:
        script: |
          const issueNumber = ${{ steps.parse.outputs.issue_number }};
          const taskType = process.env.TASK_TYPE;
          const assignedAI = process.env.ASSIGNED_AI;
          
          const comment = `ðŸ¤– **AI Orchestra ìž‘ì—… ì‹œìž‘**
          
          ìž‘ì—… ìœ í˜•: ${taskType}
          ë°°ì •ëœ AI: ${assignedAI}
          
          ê° AIê°€ ìˆœì°¨ì ìœ¼ë¡œ ìž‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
          1. Gemini: ì•„í‚¤í…ì²˜ ì„¤ê³„
          2. Codex: ë°±ì—”ë“œ êµ¬í˜„
          3. Claude: í†µí•© ë° ë¦¬ë·°
          
          ì§„í–‰ ìƒí™©ì€ ì´ ì´ìŠˆì— ëŒ“ê¸€ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.`;
          
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber,
            body: comment
          });
          
    - name: Execute AI Tasks
      run: |
        # ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ê° AI CLIë¥¼ í˜¸ì¶œ
        # ì—¬ê¸°ì„œëŠ” ì‹œë®¬ë ˆì´ì…˜
        echo "Executing AI tasks for issue #${{ steps.parse.outputs.issue_number }}"
        echo "Task type: $TASK_TYPE"
        echo "Assigned AI: $ASSIGNED_AI"
        
        # ê²°ê³¼ íŒŒì¼ ìƒì„± (ì‹œë®¬ë ˆì´ì…˜)
        mkdir -p results
        echo "# AI ìž‘ì—… ê²°ê³¼" > results/output.md
        echo "Issue: #${{ steps.parse.outputs.issue_number }}" >> results/output.md
        echo "ìž‘ì—… ì™„ë£Œ" >> results/output.md
        
    - name: Post Results
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const issueNumber = ${{ steps.parse.outputs.issue_number }};
          
          let result = 'âœ… **ìž‘ì—… ì™„ë£Œ**\n\n';
          
          if (fs.existsSync('results/output.md')) {
            const output = fs.readFileSync('results/output.md', 'utf8');
            result += output;
          }
          
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber,
            body: result
          });
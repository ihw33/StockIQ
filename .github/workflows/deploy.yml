name: Deploy to Synology NAS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build
        env:
          NODE_ENV: production

      - name: Prepare deployment files
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp next.config.js deploy/
          cp .env.example deploy/
          echo "Build complete. Ready to deploy."

      - name: Deploy to Synology NAS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 172.30.1.34
          username: thomas
          password: ${{ secrets.SYNOLOGY_PASSWORD }}
          port: 5000
          script: |
            # ë°°í¬ ê²½ë¡œ ì„¤ì •
            DEPLOY_PATH="/volume1/docker/stockiq/current"
            BACKUP_PATH="/volume1/docker/stockiq/backup_$(date +%Y%m%d_%H%M%S)"
            LOGS_PATH="/volume1/docker/stockiq/logs"

            # ë¡œê·¸ í´ë” ìƒì„±
            mkdir -p "$LOGS_PATH"

            # ê¸°ì¡´ ë°±ì—…
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ê¸°ì¡´ ë²„ì „ ë°±ì—… ì¤‘..."
              cp -r "$DEPLOY_PATH" "$BACKUP_PATH"
              echo "ë°±ì—… ì™„ë£Œ: $BACKUP_PATH"
            fi

            # ìƒˆë¡œìš´ ë°°í¬ í´ë” ìƒì„±
            mkdir -p "$DEPLOY_PATH"

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€
            echo "ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€ ì¤‘..."
            pkill -f "node.*3000" 2>/dev/null || true
            docker stop stockiq 2>/dev/null || true
            docker rm stockiq 2>/dev/null || true

            echo "íŒŒì¼ ë°°ì¹˜ ì¤€ë¹„ ì™„ë£Œ. ìƒˆ íŒŒì¼ì´ ì—…ë¡œë“œë  ì˜ˆì •ì…ë‹ˆë‹¤."

      - name: Copy files and restart service
        uses: appleboy/ssh-action@master
        with:
          host: 172.30.1.34
          username: thomas
          password: ${{ secrets.SYNOLOGY_PASSWORD }}
          port: 5000
          script: |
            DEPLOY_PATH="/volume1/docker/stockiq/current"
            LOGS_PATH="/volume1/docker/stockiq/logs"

            cd "$DEPLOY_PATH"

            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ í™•ì¸ ë° ì¤‘ì§€
            pkill -f "node.*3000" 2>/dev/null || true
            docker stop stockiq 2>/dev/null || true
            docker rm stockiq 2>/dev/null || true

            # Node.js ì„¤ì¹˜ í™•ì¸
            if command -v node &> /dev/null; then
              echo "Node.js ì„¤ì¹˜ë¨: $(node --version)"
            else
              echo "Node.js ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ. Docker ì»¨í…Œì´ë„ˆ ë°©ì‹ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤."
              
              # Docker Compose ë°©ì‹
              if [ -f "docker-compose.yml" ]; then
                docker-compose down
                docker-compose up -d --build
                echo "Docker Composeë¡œ ì‹¤í–‰ ì™„ë£Œ"
              elif [ -f "Dockerfile" ]; then
                docker build -t stockiq:latest .
                docker run -d \
                  --name stockiq \
                  --restart always \
                  -p 3000:3000 \
                  -p 8000:8000 \
                  -e NODE_ENV=production \
                  -v "$LOGS_PATH:/app/logs" \
                  stockiq:latest
                echo "Docker ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰ ì™„ë£Œ"
              else
                echo "Docker ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
                exit 1
              fi
              
              # 10ì´ˆ ëŒ€ê¸° í›„ ìƒíƒœ í™•ì¸
              sleep 10
              
              echo "=== ë°°í¬ ì™„ë£Œ! ì„œë²„ ìƒíƒœ ==="
              curl -s http://localhost:3000 | head -3 || echo "í”„ë¡ íŠ¸ì—”ë“œ ì‘ë‹µ ì—†ìŒ"
              
              echo ""
              echo "Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
              docker ps | grep stockiq || echo "Docker ì»¨í…Œì´ë„ˆ ì—†ìŒ"
              
              exit 0
            fi
            
            # Node.js ì§ì ‘ ì‹¤í–‰ ë°©ì‹
            echo "ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            npm ci --production
            
            # ë¹Œë“œ
            echo "ë¹Œë“œ ì¤‘..."
            npm run build
            
            # í”„ë¡œì„¸ìŠ¤ ì‹œì‘
            echo "í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì¤‘..."
            nohup npm start > "$LOGS_PATH/app.log" 2>&1 &
            
            # 5ì´ˆ ëŒ€ê¸° í›„ ìƒíƒœ í™•ì¸
            sleep 5
            
            echo "=== ë°°í¬ ì™„ë£Œ! ì„œë²„ ìƒíƒœ ==="
            curl -s http://localhost:3000 | head -3 || echo "í”„ë¡ íŠ¸ì—”ë“œ ì‘ë‹µ ì—†ìŒ"
            
            echo ""
            echo "Node.js í”„ë¡œì„¸ìŠ¤:"
            ps aux | grep "node.*stockiq" | grep -v grep || echo "Node.js í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"

      - name: Notify deployment success
        if: success()
        run: |
          echo "ğŸš€ ë°°í¬ ì™„ë£Œ!"
          echo "Synology NAS: http://172.30.1.34:3000"
          echo "GitHub: https://github.com/ihw33/StockIQ"
          echo "ë°°í¬ ì‹œê°„: $(date)"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          echo "GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
          echo "https://github.com/ihw33/StockIQ/actions"

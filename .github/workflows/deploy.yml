name: Deploy to Synology NAS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build
        env:
          NODE_ENV: production

      - name: Prepare deployment files
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/
          cp package.json deploy/
          cp package-lock.json deploy/
          cp next.config.js deploy/
          cp .env.example deploy/
          echo "Build complete. Ready to deploy."

      - name: Deploy to Synology NAS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 172.30.1.34
          username: thomas
          password: ${{ secrets.SYNOLOGY_PASSWORD }}
          port: 5000
          script: |
            # ë°°í¬ ê²½ë¡œ ì„¤ì •
            DEPLOY_PATH="/volume1/docker/stockiq/current"
            BACKUP_PATH="/volume1/docker/stockiq/backup_$(date +%Y%m%d_%H%M%S)"

            # ê¸°ì¡´ ë°±ì—…
            if [ -d "$DEPLOY_PATH" ]; then
              echo "ê¸°ì¡´ ë²„ì „ ë°±ì—… ì¤‘..."
              cp -r "$DEPLOY_PATH" "$BACKUP_PATH"
              echo "ë°±ì—… ì™„ë£Œ: $BACKUP_PATH"
            fi

            mkdir -p "$DEPLOY_PATH"

            echo "íŒŒì¼ ë°°ì¹˜ ì¤€ë¹„ ì™„ë£Œ"

      - name: Deploy files to Synology
        uses: burnett01/rsync-deployments@5.2.3
        with:
          switches: -avzr --delete
          path: deploy/
          remote_path: /volume1/docker/stockiq/current
          remote_host: thomas@172.30.1.34
          remote_password: ${{ secrets.SYNOLOGY_PASSWORD }}
          remote_port: 5000

      - name: Restart service
        uses: appleboy/ssh-action@master
        with:
          host: 172.30.1.34
          username: thomas
          password: ${{ secrets.SYNOLOGY_PASSWORD }}
          port: 5000
          script: |
            DEPLOY_PATH="/volume1/docker/stockiq/current"
            LOGS_PATH="/volume1/docker/stockiq/logs"
            
            mkdir -p "$LOGS_PATH"
            cd "$DEPLOY_PATH"
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€
            pkill -f "node.*3000" 2>/dev/null || true
            
            # Node.js ì„¤ì¹˜ í™•ì¸
            if command -v node &> /dev/null; then
              echo "Node.js ì„¤ì¹˜ë¨: $(node --version)"
            else
              echo "Node.js ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ"
              exit 1
            fi
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            npm ci --production
            
            # ë¹Œë“œ
            echo "ë¹Œë“œ ì¤‘..."
            npm run build
            
            # í”„ë¡œì„¸ìŠ¤ ì‹œì‘
            echo "í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì¤‘..."
            nohup npm start > "$LOGS_PATH/app.log" 2>&1 &
            
            sleep 5
            
            echo "=== ë°°í¬ ì™„ë£Œ! ì„œë²„ ìƒíƒœ ==="
            curl -s http://localhost:3000 | head -3

      - name: Notify success
        if: success()
        run: |
          echo "ğŸš€ ë°°í¬ ì™„ë£Œ!"
          echo "Synology NAS: http://172.30.1.34:3000"
          echo "GitHub: https://github.com/ihw33/StockIQ"
          echo "ë°°í¬ ì‹œê°„: $(date)"

      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          echo "GitHub Actions ë¡œê·¸ í™•ì¸: https://github.com/ihw33/StockIQ/actions"
